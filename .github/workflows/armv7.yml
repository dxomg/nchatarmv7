name: Linux ARMv7 Cross-Compile

on:
  push:
    branches:
      - main
      - master
      - dev/*
  pull_request:

jobs:
  build-armv7:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y cmake ninja-build build-essential curl

      - name: Setup ARMv7 cross-compiler and libraries
        run: |
          sudo dpkg --add-architecture armhf
          echo "deb [arch=armhf] http://deb.debian.org/debian bullseye main" | sudo tee /etc/apt/sources.list.d/armhf.list
          sudo apt-get update -y
          sudo apt-get install -y \
            gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf \
            libsqlite3-dev:armhf

      - name: Configure (CMake for ARMv7)
        run: |
          mkdir -p build-armv7
          cd build-armv7
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_SYSTEM_NAME=Linux \
            -DCMAKE_SYSTEM_PROCESSOR=armv7 \
            -DCMAKE_C_COMPILER=arm-linux-gnueabihf-gcc \
            -DCMAKE_CXX_COMPILER=arm-linux-gnueabihf-g++ \
            -DCMAKE_FIND_ROOT_PATH_MODE_LIBRARY=ONLY \
            -DCMAKE_FIND_ROOT_PATH_MODE_INCLUDE=ONLY

      - name: Build (ARMv7)
        run: cmake --build build-armv7 --parallel

      - name: Upload ARMv7 artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-armv7
          path: build-armv7/
