name: Build (ARMv7)

on:
  push:
    branches: [ main, master, dev/* ]
  pull_request:

jobs:
  build-armv7:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            ccache cmake build-essential gperf help2man \
            libreadline-dev libssl-dev libncurses-dev libncursesw5-dev \
            zlib1g-dev libsqlite3-dev libmagic-dev golang \
            crossbuild-essential-armhf

      - name: Configure ARMv7 build
        run: |
          mkdir -p build-armv7
          cd build-armv7
          cat > toolchain-armv7.cmake <<EOF
          set(CMAKE_SYSTEM_NAME Linux)
          set(CMAKE_SYSTEM_PROCESSOR arm)

          set(CMAKE_C_COMPILER arm-linux-gnueabihf-gcc)
          set(CMAKE_CXX_COMPILER arm-linux-gnueabihf-g++)
          set(CMAKE_FIND_ROOT_PATH /usr/arm-linux-gnueabihf /usr/lib/arm-linux-gnueabihf)

          set(CMAKE_C_FLAGS "-march=armv7-a -mfpu=neon -mfloat-abi=hard")
          set(CMAKE_CXX_FLAGS "\${CMAKE_C_FLAGS}")

          set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
          set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
          set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
          set(CMAKE_FIND_ROOT_PATH_MODE_PACKAGE ONLY)
          EOF

          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_TOOLCHAIN_FILE=toolchain-armv7.cmake \
            -DENABLE_CCACHE=ON

      - name: Build
        run: |
          cd build-armv7
          make -j$(nproc)

      - name: Upload ARMv7 artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-armv7
          path: build-armv7/
